version: "3.8"

services:
    danceagent-api:
        build:
            context: .
            dockerfile: Dockerfile
        environment:
            - "DB_PASSWORD=${DB_ROOT_PASSWORD}"
            - "SPRING_PROFILES_ACTIVE=prod"
        ports:
            - "8080"
        labels:
            - "traefik.http.services.danceagent-api.loadbalancer.server.port=8080"
            - "traefik.http.routers.danceagent-api.rule=PathPrefix(`/danceagent-api`)"
            - "traefik.docker.network=traefik_default"
            - "traefik.http.routers.danceagent-api.middlewares=danceagent-api-stripprefix"
            - "traefik.http.middlewares.danceagent-api-stripprefix.stripprefix.prefixes=/danceagent-api"
        networks:
            - traefik_default
            - internal
        depends_on:
            - db
    db:
        image: mariadb:10.7.1
        volumes:
            - ./src/main/resources/schema.sql:/docker-entrypoint-initdb.d/init.sql
            - danceagent-storage:/var/lib/mysql
        environment:
            MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
            MYSQL_DATABASE: danceagent
        networks:
            - internal

volumes:
  danceagent-storage:

networks:
  traefik_default:
    external: true
  internal:
    external: false
    